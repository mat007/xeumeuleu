<?xml version="1.0"?>
<project name="xeumeuleu" default="all">

    <property environment="env"/>
    <import file="${env.PONEY_HOME}/poney.xml"/>

    <!--
    ============================================================================
      tests
    ============================================================================
    -->
    <target name="xeumeuleu_test" description="build and run tests">
        <build-test name="xeumeuleu" depends="boost" libs="xerces-c_2"/>
    </target>

    <target name="xeuseuleu_test" description="build and run tests">
        <build-test name="xeuseuleu" libs="xerces-c_2,Xalan-C_1"/>
    </target>

    <!--
    ============================================================================
      applications
    ============================================================================
    -->
    <target name="xeumeuleu_bench" description="build benchmark application">
        <build-app name="xeumeuleu_bench" depends="boost" libs="xerces-c_2" subsystem="console"/>
    </target>

    <target name="xeumeuleu_clean" description="build cleaning application">
        <build-app name="xeumeuleu_clean" depends="boost" libs="xerces-c_2" subsystem="console"/>
    </target>

    <!--
    ============================================================================
      clean
    ============================================================================
    -->
    <target name="clean" description="clean intermediate build artifacts">
        <delete dir="${out.dir}"/>
    </target>

    <!--
    ============================================================================
      export
    ============================================================================
    -->
    <target name="export" depends="build" description="export the distribution">
        <deploy>
            <module name="xeumeuleu">
                <include name="**/*.hpp"/>
                <include name="**/*.h"/>
            </module>
            <module name="xeuseuleu">
                <include name="**/*.hpp"/>
                <include name="**/*.h"/>
            </module>
        </deploy>
        <copy todir="${dist.dir}/lib/${platform}" flatten="true" preservelastmodified="true">
            <fileset dir="${out.dir}" includes="**/xeumeuleu_static*.lib,**/xeumeuleu_static*.pdb"/>
        </copy>
    </target>

    <!--
    ============================================================================
      package
    ============================================================================
    -->
    <target name="package" depends="generate-vc71,generate-vc90" description="package the distribution">
        <mkdir dir="${dist.dir}"/>
        <zip destfile="${dist.dir}/xeumeuleu.zip" basedir=".." includes="build/**,src/**,data/**,*.txt" excludes="**/*.suo,**/*.ncb,**/.*,**/*.user,src/documentation/**"/>
        <tar destfile="${dist.dir}/xeumeuleu.tar.bz2" basedir=".." includes="build/**,src/**,data/**,*.txt" excludes="**/*.suo,**/*.ncb,**/.*,**/*.user,src/documentation/**" compression="bzip2"/>
    </target>

    <target name="generate-vc71" description="create vc71 build files from vc80 files">
        <copy todir="vc71" overwrite="true">
            <fileset dir="vc80" includes="*.sln,*.vcproj"/>
            <filterchain>
                <tokenfilter>
                    <replacestring from="vc80" to="vc71"/>
                    <replacestring from="8.00" to="7.10"/>
                    <replacestring from="8,00" to="7,10"/>
                    <replacestring from="9.00" to="8.00"/>
                    <replacestring from="9,00" to="8,00"/>
                    <replacestring from="UsePrecompiledHeader=&quot;2&quot;" to="UsePrecompiledHeader=&quot;3&quot;"/>
                </tokenfilter>
            </filterchain>
        </copy>
    </target>

    <target name="generate-vc90" description="create vc90 build files from vc80 files">
        <copy todir="vc90" overwrite="true">
            <fileset dir="vc80" includes="*.sln,*.vcproj"/>
            <filterchain>
                <tokenfilter>
                    <replacestring from="vc80" to="vc90"/>
                    <replacestring from="9.00" to="10.00"/>
                    <replacestring from="9,00" to="10,00"/>
                    <replacestring from="8.00" to="9.00"/>
                    <replacestring from="8,00" to="9,00"/>
                </tokenfilter>
            </filterchain>
        </copy>
    </target>

    <!--
    ============================================================================
      documentation
    ============================================================================
    -->
    <target name="documentation" description="create documentation">
        <cpd-report/>
        <xslt taskname="cpd" in="${reports.dir}/all_test.xml" out="${doc.dir}/tmp/docbook/tests.xml" extension=".xml" style="${src.dir}/documentation/docbook/boosttest2docbook.xsl"/>
        <tests-report/>
        <xslt taskname="tests-report" in="${reports.dir}/${ant.project.name}-cpd.xml" out="${doc.dir}/tmp/docbook/cpd.xml" extension=".xml" style="${src.dir}/documentation/docbook/cpd2docbook.xsl"/>
        <cppncss-report>
            <define name="TRY"/>
            <define name="CATCH"/>
            <macro name="BOOST_CHECK_THROW"/>
            <macro name="BOOST_CHECK_NO_THROW"/>
            <macro name="BOOST_REQUIRE_THROW"/>
            <macro name="BOOST_REQUIRE_NO_THROW"/>
        </cppncss-report>
        <xslt taskname="cppncss" in="${reports.dir}/${ant.project.name}-cppncss.xml" out="${doc.dir}/tmp/docbook/cppncss.xml" extension=".xml" style="${src.dir}/documentation/docbook/cppncss2docbook.xsl"/>
        <delete file="${doc.dir}/reference/xeumeuleu/html/index.html"/>
        <docbook-website input="${src.dir}/documentation/docbook" script="file:////${src.dir}/documentation/docbook/website.xsl"/>
        <docbook-extract page="${doc.dir}/reference/xeumeuleu/html/index.html" title="&lt;h1&gt;Reference&lt;/h1&gt;"/>
        <doxygen-report>
            <property name="HTML_HEADER" value="${doc.dir}/tmp/docbook/header.html"/>
            <property name="HTML_FOOTER" value="${doc.dir}/tmp/docbook/footer.html"/>
        </doxygen-report>
    </target>

    <target name="site" depends="documentation" description="deploy web site">
        <input addproperty="deploy.scp.username" message="Enter username to enable scp to deploy:"/>
        <property name="deploy.scp.dest" value="${deploy.scp.username}@web.sourceforge.net:/home/groups/x/xe/xeumeuleu/htdocs"/>
        <input addproperty="deploy.scp.password" message="Enter remote password to enable scp to ${deploy.scp.dest}:"/>
        <!-- requires scp : http://ant.apache.org/manual/OptionalTasks/scp.html -->
        <scp todir="${deploy.scp.dest}" password="${deploy.scp.password}" trust="yes" verbose="true">
            <fileset dir="${doc.dir}/site"/>
        </scp>
    </target>

    <!--
    ============================================================================
      main
    ============================================================================
    -->
    <target name="test" depends="xeumeuleu_test,xeuseuleu_test" description="run all tests"/>

    <target name="build" depends="xeumeuleu_bench,xeumeuleu_clean" description="build all"/>

    <target name="configure" description="initialize local project structure with dependencies">
        <update name="boost"/>
        <update name="mockpp"/>
        <update name="xerces-c"/>
        <update name="xalan-c"/>
    </target>

    <target name="all" depends="configure,build,test,export,package" description="build, run tests, package distribution and create web site"/>

</project>
